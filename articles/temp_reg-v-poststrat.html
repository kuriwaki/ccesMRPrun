<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Post-stratification vs. Aggregate Regression Adjustment • ccesMRPrun</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Post-stratification vs. Aggregate Regression Adjustment">
<meta property="og:description" content="ccesMRPrun">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ccesMRPrun</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/temp_reg-v-poststrat.html">Post-stratification vs. Aggregate Regression Adjustment</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/kuriwaki/ccesMRPrun/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="temp_reg-v-poststrat_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Post-stratification vs. Aggregate Regression Adjustment</h1>
                        <h4 class="author">Shiro Kuriwaki</h4>
            
      
      <small class="dont-index">Source: <a href="http://github.com/kuriwaki/ccesMRPrun/blob/master/vignettes/temp_reg-v-poststrat.Rmd"><code>vignettes/temp_reg-v-poststrat.Rmd</code></a></small>
      <div class="hidden name"><code>temp_reg-v-poststrat.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms">brms</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.github.com/kuriwaki/ccesMRPrun">ccesMRPrun</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.github.com/kuriwaki/ccesMRPprep">ccesMRPprep</a></span><span class="op">)</span></code></pre></div>
<p>Variables like party ID and religion are not available in the population target. This is a major challenge in MRP (see Leemann and Wasserfallen, <a href="https://doi.org/10.1111/ajps.12319">2017</a>).</p>
<div id="approach-1-aggregate-regression" class="section level1">
<h1 class="hasAnchor">
<a href="#approach-1-aggregate-regression" class="anchor"></a>Approach 1: Aggregate Regression</h1>
<p>One option that researchers often use is to include a area-level proportion and simply “control” for that aggregate variable in the regression. This is <em>not</em> the same as poststratification, but we believe that it helps to account for this variable in some way. (An alternative option, which I examine in the next section is to impute this to the population target through a machine learning model trained on individual data. This strategy introduces some modeling error but still allows for post-stratification.)</p>
<p>Let’s explore this proposition with a simple test case. Suppose we want to know the <em>proportion of a CD’s adults that have a high school degree or less</em>. This quantity is known in the aggregate and in some joint tables through the ACS, so we have a ground truth in this simulation.</p>
<p>First create the dummy variable of interest.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs_GA</span> <span class="op">&lt;-</span> <span class="va">acs_GA</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>is_HS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">educ</span> <span class="op">==</span> <span class="st">"HS or Less"</span><span class="op">)</span>,
         is_BA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">educ</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"4-Year"</span>, <span class="st">"Post-Grad"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><code>acs_GA</code> is a sample ACS population table. Education is already in the data, but suppose we do not know it.</p>
<p>With this binary variable, let’s compute the CD-level quantity of interest.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">val</span> <span class="op">&lt;-</span> <span class="va">acs_GA</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">cd</span>, <span class="va">is_HS</span>, <span class="va">is_BA</span>, wt <span class="op">=</span> <span class="va">count</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cd</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>prop_HS_truth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">is_HS</span><span class="op">*</span><span class="va">n</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>

<span class="va">acs_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">acs_GA</span>, <span class="va">val</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = "cd"</span></code></pre></div>
<p>Now suppose we have survey data we want to use for MRP.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cces_df</span> <span class="op">&lt;-</span> <span class="va">cces_GA</span> <span class="op">%&gt;%</span>
  <span class="co"># same as ACS manipulation</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>is_HS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">educ</span> <span class="op">==</span> <span class="st">"HS or Less"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cd</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># suppose you know the population aggregate</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">acs_df</span>, <span class="va">cd</span>, <span class="va">prop_HS_truth</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>we merge <code>prop_HS_truth</code> here like a CD-level election result: we will <em>suppose</em> that we don’t have the <code>educ</code> variable in the ACS but we do know the CD-level aggregate, so we merge that in. Notice that this duplicates the rows for every CCES respondent in a given CD.</p>
<p>Not surprisingly, the CD-level aggregate is predictive of the outcome (coefficient 0.85, t-stat of 7).</p>
<p>Also notice that for this example, we are basically giving away the answer (<code>prop_HS_truth</code> is the quantity of interest, but we are going to throw it in the regression). Usually you have a predictive proxy only, like when you want to estimate the CD-level voteshare and you only have the lagged voteshare. We are giving away the answer to give the “regression” strategy its best case scenario.</p>
<p>Now let’s try three model specifications:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># formula specs ----</span>
<span class="va">mrp_forms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"omitted"</span>   <span class="op">=</span> <span class="va">is_HS</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">cd</span><span class="op">)</span>,
  <span class="st">"mean_only"</span> <span class="op">=</span> <span class="va">is_HS</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">cd</span><span class="op">)</span> <span class="op">+</span> <span class="va">prop_HS_truth</span>,
  <span class="st">"oracle"</span>    <span class="op">=</span> <span class="va">is_HS</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">cd</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">educ</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p><code>"omitted"</code> is a version with no relevant variables in the MRP. <code>"prop_HS_truth"</code> is where we will control for the CD-level predictor but we don’t have the individual level education. <code>"oracle"</code> is the model where we would <em>post-stratify</em> on education – this is what we would do if we have both education in the survey and population joint distribution.</p>
<p>The ccesMRPrun package will do quick MRP in one step with the <code><a href="../reference/mrp_onestep.html">mrp_onestep()</a></code> function (see documentation). Let’s run MRP with these three specs, and bind the results.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># run MRP -- only change formulas at each step</span>
<span class="va">mrp_df</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span><span class="op">(</span>.x <span class="op">=</span> <span class="va">mrp_forms</span>,
                  .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
                    <span class="fu"><a href="../reference/mrp_onestep.html">mrp_onestep</a></span><span class="op">(</span><span class="va">x</span>,
                                <span class="va">cces_df</span>,
                                poststrat_tgt <span class="op">=</span> <span class="va">acs_df</span>,
                                weight_var <span class="op">=</span> <span class="st">"weight"</span>,
                                add_on <span class="op">=</span> <span class="va">val</span>, 
                                verbose <span class="op">=</span> <span class="cn">FALSE</span>,
                                .cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">}</span>,
                  .id <span class="op">=</span> <span class="st">"spec"</span><span class="op">)</span>
<span class="co">#&gt; Compiling Stan program...</span>
<span class="co">#&gt; Trying to compile a simple C file</span>
<span class="co">#&gt; Running /Library/Frameworks/R.framework/Resources/bin/R CMD SHLIB foo.c</span>
<span class="co">#&gt; clang -mmacosx-version-min=10.13 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG   -I"/Users/runner/work/_temp/Library/Rcpp/include/"  -I"/Users/runner/work/_temp/Library/RcppEigen/include/"  -I"/Users/runner/work/_temp/Library/RcppEigen/include/unsupported"  -I"/Users/runner/work/_temp/Library/BH/include" -I"/Users/runner/work/_temp/Library/StanHeaders/include/src/"  -I"/Users/runner/work/_temp/Library/StanHeaders/include/"  -I"/Users/runner/work/_temp/Library/RcppParallel/include/"  -I"/Users/runner/work/_temp/Library/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include '/Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/include   -fPIC  -Wall -g -O2  -c foo.c -o foo.o</span>
<span class="co">#&gt; In file included from &lt;built-in&gt;:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Dense:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Core:88:</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name 'namespace'</span>
<span class="co">#&gt; namespace Eigen {</span>
<span class="co">#&gt; ^</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected ';' after top level declarator</span>
<span class="co">#&gt; namespace Eigen {</span>
<span class="co">#&gt;                ^</span>
<span class="co">#&gt;                ;</span>
<span class="co">#&gt; In file included from &lt;built-in&gt;:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Dense:1:</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Core:96:10: fatal error: 'complex' file not found</span>
<span class="co">#&gt; #include &lt;complex&gt;</span>
<span class="co">#&gt;          ^~~~~~~~~</span>
<span class="co">#&gt; 3 errors generated.</span>
<span class="co">#&gt; make: *** [foo.o] Error 1</span>
<span class="co">#&gt; Start sampling</span>
<span class="co">#&gt; Compiling Stan program...</span>
<span class="co">#&gt; Trying to compile a simple C file</span>
<span class="co">#&gt; Running /Library/Frameworks/R.framework/Resources/bin/R CMD SHLIB foo.c</span>
<span class="co">#&gt; clang -mmacosx-version-min=10.13 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG   -I"/Users/runner/work/_temp/Library/Rcpp/include/"  -I"/Users/runner/work/_temp/Library/RcppEigen/include/"  -I"/Users/runner/work/_temp/Library/RcppEigen/include/unsupported"  -I"/Users/runner/work/_temp/Library/BH/include" -I"/Users/runner/work/_temp/Library/StanHeaders/include/src/"  -I"/Users/runner/work/_temp/Library/StanHeaders/include/"  -I"/Users/runner/work/_temp/Library/RcppParallel/include/"  -I"/Users/runner/work/_temp/Library/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include '/Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/include   -fPIC  -Wall -g -O2  -c foo.c -o foo.o</span>
<span class="co">#&gt; In file included from &lt;built-in&gt;:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Dense:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Core:88:</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name 'namespace'</span>
<span class="co">#&gt; namespace Eigen {</span>
<span class="co">#&gt; ^</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected ';' after top level declarator</span>
<span class="co">#&gt; namespace Eigen {</span>
<span class="co">#&gt;                ^</span>
<span class="co">#&gt;                ;</span>
<span class="co">#&gt; In file included from &lt;built-in&gt;:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Dense:1:</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Core:96:10: fatal error: 'complex' file not found</span>
<span class="co">#&gt; #include &lt;complex&gt;</span>
<span class="co">#&gt;          ^~~~~~~~~</span>
<span class="co">#&gt; 3 errors generated.</span>
<span class="co">#&gt; make: *** [foo.o] Error 1</span>
<span class="co">#&gt; Start sampling</span>
<span class="co">#&gt; Compiling Stan program...</span>
<span class="co">#&gt; Trying to compile a simple C file</span>
<span class="co">#&gt; Running /Library/Frameworks/R.framework/Resources/bin/R CMD SHLIB foo.c</span>
<span class="co">#&gt; clang -mmacosx-version-min=10.13 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG   -I"/Users/runner/work/_temp/Library/Rcpp/include/"  -I"/Users/runner/work/_temp/Library/RcppEigen/include/"  -I"/Users/runner/work/_temp/Library/RcppEigen/include/unsupported"  -I"/Users/runner/work/_temp/Library/BH/include" -I"/Users/runner/work/_temp/Library/StanHeaders/include/src/"  -I"/Users/runner/work/_temp/Library/StanHeaders/include/"  -I"/Users/runner/work/_temp/Library/RcppParallel/include/"  -I"/Users/runner/work/_temp/Library/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include '/Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/include   -fPIC  -Wall -g -O2  -c foo.c -o foo.o</span>
<span class="co">#&gt; In file included from &lt;built-in&gt;:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Dense:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Core:88:</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name 'namespace'</span>
<span class="co">#&gt; namespace Eigen {</span>
<span class="co">#&gt; ^</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected ';' after top level declarator</span>
<span class="co">#&gt; namespace Eigen {</span>
<span class="co">#&gt;                ^</span>
<span class="co">#&gt;                ;</span>
<span class="co">#&gt; In file included from &lt;built-in&gt;:1:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:</span>
<span class="co">#&gt; In file included from /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Dense:1:</span>
<span class="co">#&gt; /Users/runner/work/_temp/Library/RcppEigen/include/Eigen/Core:96:10: fatal error: 'complex' file not found</span>
<span class="co">#&gt; #include &lt;complex&gt;</span>
<span class="co">#&gt;          ^~~~~~~~~</span>
<span class="co">#&gt; 3 errors generated.</span>
<span class="co">#&gt; make: *** [foo.o] Error 1</span>
<span class="co">#&gt; Start sampling</span>
<span class="va">mrp_df</span>
<span class="co">#&gt; # A tibble: 42 x 11</span>
<span class="co">#&gt;    spec  p_raw  p_wt cd    n_raw p_mrp_est p_mrp_050 p_mrp_100 p_mrp_900</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt;  1 omit… 0.344 0.530 GA-01   128     0.337     0.277     0.289     0.386</span>
<span class="co">#&gt;  2 omit… 0.353 0.584 GA-02   116     0.345     0.280     0.293     0.398</span>
<span class="co">#&gt;  3 omit… 0.391 0.474 GA-03   138     0.379     0.319     0.330     0.428</span>
<span class="co">#&gt;  4 omit… 0.266 0.380 GA-04   207     0.271     0.224     0.233     0.311</span>
<span class="co">#&gt;  5 omit… 0.219 0.436 GA-05   187     0.233     0.186     0.196     0.270</span>
<span class="co">#&gt;  6 omit… 0.113 0.162 GA-06   141     0.154     0.105     0.115     0.194</span>
<span class="co">#&gt;  7 omit… 0.226 0.322 GA-07   146     0.242     0.190     0.201     0.285</span>
<span class="co">#&gt;  8 omit… 0.345 0.500 GA-08   113     0.338     0.272     0.287     0.391</span>
<span class="co">#&gt;  9 omit… 0.343 0.457 GA-09   134     0.338     0.277     0.291     0.385</span>
<span class="co">#&gt; 10 omit… 0.380 0.498 GA-10   142     0.369     0.307     0.320     0.418</span>
<span class="co">#&gt; # … with 32 more rows, and 2 more variables: p_mrp_950 &lt;dbl&gt;,</span>
<span class="co">#&gt; #   prop_HS_truth &lt;dbl&gt;</span></code></pre></div>
<p>Now let’s plot the MRP results.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mrp_plot</span> <span class="op">&lt;-</span> <span class="va">mrp_df</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>spec <span class="op">=</span> <span class="fu">fct_inorder</span><span class="op">(</span><span class="va">spec</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/scatter_45.html">scatter_45</a></span><span class="op">(</span><span class="va">mrp_plot</span>,
           <span class="va">prop_HS_truth</span>,
           <span class="va">p_mrp_est</span>,
           lbvar <span class="op">=</span> <span class="va">p_mrp_050</span>,
           ubvar <span class="op">=</span> <span class="va">p_mrp_900</span>,
           by_form <span class="op">=</span> <span class="op">~</span><span class="va">spec</span>,
           show_error <span class="op">=</span> <span class="cn">TRUE</span>,
           by_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>omitted <span class="op">=</span> <span class="st">"~ (1|cd)"</span>,
                         mean_only <span class="op">=</span> <span class="st">"~ (1|cd) + proportion HS"</span>,
                         oracle <span class="op">=</span> <span class="st">"~ (1|cd) + (1|education)"</span><span class="op">)</span>,
           xlab <span class="op">=</span> <span class="st">"True Proportion of Adults with High School - only Education"</span>,
           ylab <span class="op">=</span> <span class="st">"MRP Estimate"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"Note: Estimand is proportion of CD that has a high school education or less.
       First model does not account for education.
       Third model poststratifies on education, and is therefore perfectly correct.
       Second model is only given CD-level proportion of High School-only graduates (the truth)."</span><span class="op">)</span></code></pre></div>
<p><img src="temp_reg-v-poststrat_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Notice that the second model where we only control for the CD-level aggregate will tighten the estimates around a 45 degree angle, but it does <em>not</em> make the estimates more representative. There is still a bias of the survey undersampling HS-only voters, and controlling for an aggregate does not solve this question.</p>
<p>With a closer look, we see that including the aggregate variable worsens some estimates in this case. High education districts get their estimates pulled away from the truth, while low education districts improve. This again seems to be a function of pooling where the errors become more homogeneous.</p>
<p><img src="temp_reg-v-poststrat_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div id="approach-2-synthetic-joint-estimation" class="section level1">
<h1 class="hasAnchor">
<a href="#approach-2-synthetic-joint-estimation" class="anchor"></a>Approach 2: Synthetic Joint Estimation</h1>
<p>Instead of including the aggregate information, others might opt to model a synthetic joint distribution. The ccesMRPprep function provides several methods to compute such a synthetic table.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs_syn_mlogit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ccesMRPprep/man/synth_mlogit.html">synth_mlogit</a></span><span class="op">(</span><span class="va">educ</span> <span class="op">~</span> <span class="va">female</span> <span class="op">+</span> <span class="va">age</span>,
                               microdata <span class="op">=</span> <span class="va">cces_GA</span>,
                               poptable <span class="op">=</span> <span class="va">acs_df</span>,  <span class="co"># internally will be treated as if we don't know education</span>
                               area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span></code></pre></div>
<p>On average, this produces a model where the <em>margins</em> are smoothed out nationally. In the CCES survey sample, 31% have a “HS or Less” degree, so it seems like the numbers match that. This is not surprising because there are CD “fixed effects” not captured by gender and age, but it is nonethless troubling for MRP.</p>
<p>The ccesMRPprep package provide two other approaches to estimating the joint – these incorporate another source of information, which is the margins that are available.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">edu_margins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ccesMRPprep/man/collapse_table.html">collapse_table</a></span><span class="op">(</span><span class="va">acs_GA</span>, area_var <span class="op">=</span> <span class="st">"cd"</span>, X_vars <span class="op">=</span> <span class="st">"educ"</span>, 
                              count_var <span class="op">=</span> <span class="st">"count"</span>, new_name <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span>
<span class="va">edu_margins</span>
<span class="co">#&gt; # A tibble: 56 x 3</span>
<span class="co">#&gt;    cd    educ          count</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;fct&gt;         &lt;dbl&gt;</span>
<span class="co">#&gt;  1 GA-01 HS or Less   243060</span>
<span class="co">#&gt;  2 GA-01 Some College 182614</span>
<span class="co">#&gt;  3 GA-01 4-Year        77683</span>
<span class="co">#&gt;  4 GA-01 Post-Grad     44842</span>
<span class="co">#&gt;  5 GA-02 HS or Less   271726</span>
<span class="co">#&gt;  6 GA-02 Some College 167144</span>
<span class="co">#&gt;  7 GA-02 4-Year        50349</span>
<span class="co">#&gt;  8 GA-02 Post-Grad     29694</span>
<span class="co">#&gt;  9 GA-03 HS or Less   246159</span>
<span class="co">#&gt; 10 GA-03 Some College 168159</span>
<span class="co">#&gt; # … with 46 more rows</span></code></pre></div>
<p>Given this data that is simply the marginal distribution of education in each CD, one option is to simply take the product assuming independence</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs_syn_prod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ccesMRPprep/man/synth_prod.html">synth_prod</a></span><span class="op">(</span><span class="va">educ</span> <span class="op">~</span> <span class="va">female</span> <span class="op">+</span> <span class="va">age</span>, 
                           poptable <span class="op">=</span> <span class="va">acs_GA</span>,
                           newtable <span class="op">=</span> <span class="va">edu_margins</span>,
                           area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span></code></pre></div>
<p>and another is to first comibine the survey modeling then fix <em>those</em> margins to the known population margins.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs_syn_fix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ccesMRPprep/man/synth_mlogit.html">synth_smoothfix</a></span><span class="op">(</span><span class="va">educ</span> <span class="op">~</span> <span class="va">female</span> <span class="op">+</span> <span class="va">age</span>, 
                               microdata <span class="op">=</span> <span class="va">cces_GA</span>,
                               poptable <span class="op">=</span> <span class="va">acs_GA</span>, 
                               fix_to <span class="op">=</span> <span class="va">edu_margins</span>,
                               area_var <span class="op">=</span> <span class="st">"cd"</span><span class="op">)</span></code></pre></div>
<p>See the ccesMRPprep vignette for validation.</p>
<p>In any case, this allows us to run MRP using this “synthetic” target. Now let’s fix the specification and vary the targets</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">syn_datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="st">"survey"</span>       <span class="op">=</span> <span class="va">acs_syn_mlogit</span>,
  <span class="st">"product"</span>      <span class="op">=</span> <span class="va">acs_syn_prod</span>,
  <span class="st">"surveyfix"</span>    <span class="op">=</span> <span class="va">acs_syn_fix</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mrsp_df</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span><span class="op">(</span>.x <span class="op">=</span> <span class="va">syn_datasets</span>,
                   .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
                     <span class="fu"><a href="../reference/mrp_onestep.html">mrp_onestep</a></span><span class="op">(</span><span class="va">is_HS</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">educ</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">cd</span><span class="op">)</span>,
                                 <span class="va">cces_df</span>,
                                 poststrat_tgt <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">x</span>, count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span>,
                                 weight_var <span class="op">=</span> <span class="st">"weight"</span>,
                                 add_on <span class="op">=</span> <span class="va">val</span>, 
                                 verbose <span class="op">=</span> <span class="cn">FALSE</span>,
                                 .cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">}</span>,
                   .id <span class="op">=</span> <span class="st">"synth"</span><span class="op">)</span>
<span class="co">#&gt; Compiling Stan program...</span>
<span class="co">#&gt; Start sampling</span>
<span class="co">#&gt; Compiling Stan program...</span>
<span class="co">#&gt; Start sampling</span>
<span class="co">#&gt; Compiling Stan program...</span>
<span class="co">#&gt; Start sampling</span></code></pre></div>
<p>And examine the outcome.</p>
<p><img src="temp_reg-v-poststrat_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>The first estimate look bad. If the imputation is faulty, it is not a good idea to use that to post-stratify, either. The only reason the second and third estimates are perfect is because we asked MRP <em>for an outcome</em> for which we supplied the joint for. If we were estimating a different outcome for which the margins are not known (which in practice is always the case), the values would change, of course.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.shirokuriwaki.com">Shiro Kuriwaki</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
